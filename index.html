import os
import json
import logging
import sqlite3
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any, Union
import pytz
import secrets
import requests
import threading
import time

from flask import Flask, render_template_string, request, jsonify, session, redirect, url_for, flash
from flask_session import Session
from werkzeug.security import generate_password_hash, check_password_hash
from dotenv import load_dotenv
from apscheduler.schedulers.background import BackgroundScheduler
from zoneinfo import ZoneInfo

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# ============================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ============================

# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è Flask (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
SECRET_KEY = os.getenv("SECRET_KEY", secrets.token_hex(32))

# –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DEFAULT_TIMEZONE = "Europe/Moscow"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
TIMEZONE = os.getenv("TIMEZONE", DEFAULT_TIMEZONE)
MAX_CHANNELS_PER_USER = 50
DAILY_POST_LIMIT = 100
MAX_POSTS_PER_DAY = 1000

# ============================
# –ù–ê–°–¢–†–û–ô–ö–ê FLASK
# ============================

app = Flask(__name__)
app.secret_key = SECRET_KEY
app.config['SESSION_TYPE'] = 'filesystem'
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(hours=24)
Session(app)

# ============================
# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø
# ============================

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# ============================
# –ü–õ–ê–ù–ò–†–û–í–©–ò–ö
# ============================

scheduler = BackgroundScheduler(timezone=TIMEZONE)

# ============================
# –ú–ï–ù–ï–î–ñ–ï–† TELEGRAM –ë–û–¢–û–í
# ============================

class TelegramBotManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram –±–æ—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    
    @staticmethod
    def validate_bot_token(token: str) -> tuple[bool, Optional[Dict]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞"""
        try:
            url = f"https://api.telegram.org/bot{token}/getMe"
            response = requests.get(url, timeout=10)
            data = response.json()
            
            if data.get('ok'):
                return True, data['result']
            return False, None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞: {e}")
            return False, None
    
    @staticmethod
    def send_message(token: str, chat_id: Union[str, int], text: str, parse_mode: str = "HTML") -> bool:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞"""
        try:
            url = f"https://api.telegram.org/bot{token}/sendMessage"
            payload = {
                'chat_id': chat_id,
                'text': text,
                'parse_mode': parse_mode
            }
            response = requests.post(url, json=payload, timeout=10)
            return response.json().get('ok', False)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return False
    
    @staticmethod
    def send_photo(token: str, chat_id: Union[str, int], photo_url: str, caption: str = None) -> bool:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞"""
        try:
            url = f"https://api.telegram.org/bot{token}/sendPhoto"
            
            if photo_url.startswith('http'):
                # URL —Ñ–æ—Ç–æ
                payload = {
                    'chat_id': chat_id,
                    'photo': photo_url
                }
                if caption:
                    payload['caption'] = caption
                    payload['parse_mode'] = 'HTML'
                
                response = requests.post(url, json=payload, timeout=10)
            else:
                # –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ)
                return False
            
            return response.json().get('ok', False)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ: {e}")
            return False
    
    @staticmethod
    def get_chat_info(token: str, chat_id: Union[str, int]) -> Optional[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ/–∫–∞–Ω–∞–ª–µ"""
        try:
            url = f"https://api.telegram.org/bot{token}/getChat"
            payload = {'chat_id': chat_id}
            response = requests.post(url, json=payload, timeout=10)
            data = response.json()
            
            if data.get('ok'):
                return data['result']
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ: {e}")
            return None
    
    @staticmethod
    def get_chat_member(token: str, chat_id: Union[str, int], user_id: int) -> Optional[Dict]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª–µ"""
        try:
            url = f"https://api.telegram.org/bot{token}/getChatMember"
            payload = {
                'chat_id': chat_id,
                'user_id': user_id
            }
            response = requests.post(url, json=payload, timeout=10)
            data = response.json()
            
            if data.get('ok'):
                return data['result']
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤: {e}")
            return None

# ============================
# –ë–ê–ó–ê –î–ê–ù–ù–´–•
# ============================

class Database:
    def __init__(self):
        self.conn = sqlite3.connect('telegram_scheduler_v2.db', check_same_thread=False)
        self.conn.row_factory = sqlite3.Row
        self.cursor = self.conn.cursor()
        self.create_tables()
        self.create_admin_user()
    
    def create_tables(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü"""
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∏—Ö —Ç–æ–∫–µ–Ω–∞–º–∏ –±–æ—Ç–æ–≤
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                password TEXT NOT NULL,
                email TEXT,
                telegram_id INTEGER,
                bot_token TEXT,
                bot_username TEXT,
                bot_first_name TEXT,
                timezone TEXT DEFAULT ?,
                is_active BOOLEAN DEFAULT TRUE,
                is_admin BOOLEAN DEFAULT FALSE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_login TIMESTAMP
            )
        ''', (DEFAULT_TIMEZONE,))
        
        # –ö–∞–Ω–∞–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS channels (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                channel_id TEXT NOT NULL,
                title TEXT NOT NULL,
                username TEXT,
                invite_link TEXT,
                subscribers_count INTEGER DEFAULT 0,
                is_active BOOLEAN DEFAULT TRUE,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_used TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                UNIQUE(user_id, channel_id)
            )
        ''')
        
        # –ü–æ—Å—Ç—ã
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS posts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                title TEXT,
                content_type TEXT DEFAULT 'text',
                content TEXT,
                media_url TEXT,
                media_type TEXT,
                channels_json TEXT,
                scheduled_time TIMESTAMP,
                timezone TEXT DEFAULT ?,
                status TEXT DEFAULT 'draft',
                sent_at TIMESTAMP,
                views_count INTEGER DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
            )
        ''', (DEFAULT_TIMEZONE,))
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS daily_stats (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                date DATE,
                posts_created INTEGER DEFAULT 0,
                posts_scheduled INTEGER DEFAULT 0,
                posts_sent INTEGER DEFAULT 0,
                posts_failed INTEGER DEFAULT 0,
                total_views INTEGER DEFAULT 0,
                UNIQUE(user_id, date),
                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
            )
        ''')
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS notifications (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                type TEXT,
                title TEXT,
                message TEXT,
                is_read BOOLEAN DEFAULT FALSE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
            )
        ''')
        
        # –ß–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞ (—Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞)
        self.cursor.execute('''
            CREATE TABLE IF NOT EXISTS timezones (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                value TEXT NOT NULL UNIQUE,
                offset TEXT,
                is_active BOOLEAN DEFAULT TRUE
            )
        ''')
        
        self.init_timezones()
        self.conn.commit()
        logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    
    def init_timezones(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤"""
        popular_timezones = [
            ('–ú–æ—Å–∫–≤–∞', 'Europe/Moscow', '+03:00'),
            ('–ö–∏–µ–≤', 'Europe/Kiev', '+02:00'),
            ('–õ–æ–Ω–¥–æ–Ω', 'Europe/London', '+00:00'),
            ('–ë–µ—Ä–ª–∏–Ω', 'Europe/Berlin', '+01:00'),
            ('–ü–∞—Ä–∏–∂', 'Europe/Paris', '+01:00'),
            ('–ù—å—é-–ô–æ—Ä–∫', 'America/New_York', '-05:00'),
            ('–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å', 'America/Los_Angeles', '-08:00'),
            ('–¢–æ–∫–∏–æ', 'Asia/Tokyo', '+09:00'),
            ('–ü–µ–∫–∏–Ω', 'Asia/Shanghai', '+08:00'),
            ('–°–∏–¥–Ω–µ–π', 'Australia/Sydney', '+10:00'),
            ('–î—É–±–∞–π', 'Asia/Dubai', '+04:00'),
            ('–°–∏–Ω–≥–∞–ø—É—Ä', 'Asia/Singapore', '+08:00'),
            ('–ú–∏–Ω—Å–∫', 'Europe/Minsk', '+03:00'),
            ('–ê—Å—Ç–∞–Ω–∞', 'Asia/Almaty', '+06:00'),
            ('–ò—Ä–∫—É—Ç—Å–∫', 'Asia/Irkutsk', '+08:00'),
            ('–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', 'Asia/Vladivostok', '+10:00')
        ]
        
        for name, value, offset in popular_timezones:
            self.cursor.execute('''
                INSERT OR IGNORE INTO timezones (name, value, offset) 
                VALUES (?, ?, ?)
            ''', (name, value, offset))
    
    def create_admin_user(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        try:
            self.cursor.execute("SELECT id FROM users WHERE username = 'admin'")
            if not self.cursor.fetchone():
                hashed_pw = generate_password_hash("Admin123!")
                self.cursor.execute(
                    '''INSERT INTO users 
                       (username, password, email, is_admin, bot_token) 
                       VALUES (?, ?, ?, ?, ?)''',
                    ("admin", hashed_pw, "admin@example.com", True, "")
                )
                self.conn.commit()
                logger.info("–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω: admin / Admin123!")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")
    
    def create_user(self, username: str, password: str, email: str = None, 
                   telegram_id: int = None, bot_token: str = None) -> tuple[bool, str, Optional[int]]:
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å username
            self.cursor.execute("SELECT id FROM users WHERE username = ?", (username,))
            if self.cursor.fetchone():
                return False, "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ", None
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
            if bot_token:
                is_valid, bot_info = TelegramBotManager.validate_bot_token(bot_token)
                if not is_valid:
                    return False, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞", None
                
                bot_username = bot_info.get('username')
                bot_first_name = bot_info.get('first_name')
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
                self.cursor.execute("SELECT id FROM users WHERE bot_token = ?", (bot_token,))
                if self.cursor.fetchone():
                    return False, "–≠—Ç–æ—Ç –±–æ—Ç —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω", None
            else:
                bot_username = None
                bot_first_name = None
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            hashed_pw = generate_password_hash(password)
            self.cursor.execute(
                '''INSERT INTO users 
                   (username, password, email, telegram_id, bot_token, 
                    bot_username, bot_first_name, timezone) 
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?)''',
                (username, hashed_pw, email, telegram_id, bot_token,
                 bot_username, bot_first_name, DEFAULT_TIMEZONE)
            )
            
            user_id = self.cursor.lastrowid
            
            # –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            self.cursor.execute(
                '''INSERT INTO notifications 
                   (user_id, type, title, message) 
                   VALUES (?, ?, ?, ?)''',
                (user_id, 'info', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 
                 f'–ü—Ä–∏–≤–µ—Ç, {username}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏.')
            )
            
            self.conn.commit()
            return True, "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞", user_id
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return False, f"–û—à–∏–±–∫–∞: {str(e)}", None
    
    def authenticate_user(self, username: str, password: str) -> Optional[Dict]:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            self.cursor.execute(
                "SELECT id, username, password, is_admin, bot_token, timezone FROM users WHERE username = ? AND is_active = TRUE",
                (username,)
            )
            user = self.cursor.fetchone()
            
            if user and check_password_hash(user['password'], password):
                # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
                self.cursor.execute(
                    "UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?",
                    (user['id'],)
                )
                self.conn.commit()
                return dict(user)
            return None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}")
            return None
    
    def update_user_timezone(self, user_id: int, timezone: str) -> bool:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            self.cursor.execute(
                "UPDATE users SET timezone = ? WHERE id = ?",
                (timezone, user_id)
            )
            self.conn.commit()
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞: {e}")
            return False
    
    def add_channel(self, user_id: int, channel_data: Dict) -> tuple[bool, str]:
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª–µ
            user = self.get_user(user_id)
            if not user or not user['bot_token']:
                return False, "–£ –≤–∞—Å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –±–æ—Ç"
            
            bot_info = TelegramBotManager.get_chat_member(
                user['bot_token'],
                channel_data['channel_id'],
                int(user['bot_token'].split(':')[0])  # user_id –∏–∑ —Ç–æ–∫–µ–Ω–∞
            )
            
            if not bot_info:
                return False, "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –±–æ—Ç–∞"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
            status = bot_info.get('status')
            if status not in ['administrator', 'creator']:
                return False, "–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∫–∞–Ω–∞–ª–∞"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
            can_post = bot_info.get('can_post_messages', False) or status == 'creator'
            if not can_post:
                return False, "–£ –±–æ—Ç–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–∞–ª
            self.cursor.execute(
                '''INSERT OR REPLACE INTO channels 
                   (user_id, channel_id, title, username, invite_link, subscribers_count) 
                   VALUES (?, ?, ?, ?, ?, ?)''',
                (user_id, channel_data['channel_id'], channel_data['title'],
                 channel_data.get('username'), channel_data.get('invite_link'),
                 channel_data.get('subscribers_count', 0))
            )
            
            self.conn.commit()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            self.add_notification(
                user_id, 
                'success',
                '–ö–∞–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω',
                f'–ö–∞–Ω–∞–ª "{channel_data["title"]}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω'
            )
            
            return True, "–ö–∞–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω"
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞: {e}")
            return False, f"–û—à–∏–±–∫–∞: {str(e)}"
    
    def create_post(self, user_id: int, post_data: Dict) -> tuple[bool, str, Optional[int]]:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞"""
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç
            today = datetime.now().date()
            self.cursor.execute(
                "SELECT posts_created FROM daily_stats WHERE user_id = ? AND date = ?",
                (user_id, today)
            )
            daily_stats = self.cursor.fetchone()
            
            posts_created = daily_stats['posts_created'] if daily_stats else 0
            if posts_created >= MAX_POSTS_PER_DAY:
                return False, f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç ({MAX_POSTS_PER_DAY} –ø–æ—Å—Ç–æ–≤)", None
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            channels_json = json.dumps(post_data.get('channels', []))
            
            self.cursor.execute(
                '''INSERT INTO posts 
                   (user_id, title, content_type, content, media_url, media_type,
                    channels_json, scheduled_time, timezone, status) 
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)''',
                (user_id, post_data.get('title'), post_data.get('content_type', 'text'),
                 post_data.get('content'), post_data.get('media_url'), 
                 post_data.get('media_type'), channels_json,
                 post_data.get('scheduled_time'), post_data.get('timezone', DEFAULT_TIMEZONE),
                 post_data.get('status', 'draft'))
            )
            
            post_id = self.cursor.lastrowid
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if daily_stats:
                self.cursor.execute(
                    "UPDATE daily_stats SET posts_created = posts_created + 1 WHERE user_id = ? AND date = ?",
                    (user_id, today)
                )
            else:
                self.cursor.execute(
                    '''INSERT INTO daily_stats 
                       (user_id, date, posts_created) 
                       VALUES (?, ?, 1)''',
                    (user_id, today)
                )
            
            self.conn.commit()
            
            # –ï—Å–ª–∏ –ø–æ—Å—Ç –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ä–∞–∑—É
            if post_data.get('status') == 'immediate':
                self.send_post_immediately(post_id, user_id)
            
            # –ü–ª–∞–Ω–∏—Ä—É–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –ø–æ—Å—Ç
            elif post_data.get('scheduled_time') and post_data.get('status') == 'scheduled':
                self.schedule_post(post_id, post_data['scheduled_time'])
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞
            self.add_notification(
                user_id,
                'info',
                '–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω',
                f'–ü–æ—Å—Ç "{post_data.get("title", "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω'
            )
            
            return True, "–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω", post_id
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞: {e}")
            return False, f"–û—à–∏–±–∫–∞: {str(e)}", None
    
    def send_post_immediately(self, post_id: int, user_id: int):
        """–ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
        thread = threading.Thread(
            target=self._send_post_thread,
            args=(post_id, user_id)
        )
        thread.daemon = True
        thread.start()
    
    def _send_post_thread(self, post_id: int, user_id: int):
        """–ü–æ—Ç–æ–∫ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞
            self.cursor.execute(
                "SELECT * FROM posts WHERE id = ? AND user_id = ?",
                (post_id, user_id)
            )
            post = self.cursor.fetchone()
            
            if not post:
                return
            
            post = dict(post)
            channels = json.loads(post['channels_json']) if post['channels_json'] else []
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = self.get_user(user_id)
            if not user or not user['bot_token']:
                self.update_post_status(post_id, 'failed', "–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
                return
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–∂–¥—ã–π –∫–∞–Ω–∞–ª
            results = []
            for channel_id in channels:
                success = self._send_to_channel(
                    user['bot_token'],
                    channel_id,
                    post
                )
                results.append({
                    'channel': channel_id,
                    'success': success
                })
                time.sleep(0.5)  # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ—Å—Ç–∞
            success_count = sum(1 for r in results if r['success'])
            if success_count > 0:
                status = 'published'
                message = f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {success_count}/{len(channels)} –∫–∞–Ω–∞–ª–æ–≤"
            else:
                status = 'failed'
                message = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∏ –≤ –æ–¥–∏–Ω –∫–∞–Ω–∞–ª"
            
            self.update_post_status(post_id, status, message)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            if user.get('telegram_id'):
                notification_text = (
                    f"üìä *–û—Ç—á–µ—Ç –ø–æ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ—Å—Ç–∞*\n\n"
                    f"üìù *–ü–æ—Å—Ç:* {post.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}\n"
                    f"‚úÖ *–£—Å–ø–µ—à–Ω–æ:* {success_count} –∫–∞–Ω–∞–ª–æ–≤\n"
                    f"‚ùå *–ù–µ —É–¥–∞–ª–æ—Å—å:* {len(channels) - success_count} –∫–∞–Ω–∞–ª–æ–≤\n"
                    f"üïê *–í—Ä–µ–º—è:* {datetime.now().strftime('%H:%M')}"
                )
                
                TelegramBotManager.send_message(
                    user['bot_token'],
                    user['telegram_id'],
                    notification_text
                )
            
            # –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É
            self.add_notification(
                user_id,
                'success' if success_count > 0 else 'error',
                '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
                message
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞: {e}")
            self.update_post_status(post_id, 'failed', str(e))
    
    def _send_to_channel(self, bot_token: str, channel_id: str, post: Dict) -> bool:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–∞–Ω–∞–ª"""
        try:
            if post['content_type'] == 'text':
                return TelegramBotManager.send_message(
                    bot_token,
                    channel_id,
                    post['content']
                )
            elif post['content_type'] == 'photo' and post['media_url']:
                return TelegramBotManager.send_photo(
                    bot_token,
                    channel_id,
                    post['media_url'],
                    post.get('content')
                )
            return False
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∫–∞–Ω–∞–ª {channel_id}: {e}")
            return False
    
    def update_post_status(self, post_id: int, status: str, message: str = None):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å—Ç–∞"""
        try:
            self.cursor.execute(
                "UPDATE posts SET status = ?, sent_at = CURRENT_TIMESTAMP WHERE id = ?",
                (status, post_id)
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            today = datetime.now().date()
            if status == 'published':
                self.cursor.execute('''
                    INSERT OR REPLACE INTO daily_stats (user_id, date, posts_sent)
                    VALUES (
                        (SELECT user_id FROM posts WHERE id = ?),
                        ?,
                        COALESCE((SELECT posts_sent FROM daily_stats WHERE user_id = (SELECT user_id FROM posts WHERE id = ?) AND date = ?), 0) + 1
                    )
                ''', (post_id, today, post_id, today))
            elif status == 'failed':
                self.cursor.execute('''
                    INSERT OR REPLACE INTO daily_stats (user_id, date, posts_failed)
                    VALUES (
                        (SELECT user_id FROM posts WHERE id = ?),
                        ?,
                        COALESCE((SELECT posts_failed FROM daily_stats WHERE user_id = (SELECT user_id FROM posts WHERE id = ?) AND date = ?), 0) + 1
                    )
                ''', (post_id, today, post_id, today))
            
            self.conn.commit()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å—Ç–∞: {e}")
    
    def schedule_post(self, post_id: int, scheduled_time: str):
        """–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏"""
        try:
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤ datetime
            scheduled_dt = datetime.fromisoformat(scheduled_time.replace('Z', '+00:00'))
            
            # –ü–ª–∞–Ω–∏—Ä—É–µ–º –∑–∞–¥–∞—á—É
            scheduler.add_job(
                self.send_post_immediately,
                'date',
                run_date=scheduled_dt,
                args=[post_id, self.get_post_user_id(post_id)],
                id=f'post_{post_id}'
            )
            
            logger.info(f"–ü–æ—Å—Ç #{post_id} –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ {scheduled_dt}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞: {e}")
    
    def get_user(self, user_id: int) -> Optional[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            self.cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
            user = self.cursor.fetchone()
            return dict(user) if user else None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return None
    
    def get_user_channels(self, user_id: int) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            self.cursor.execute(
                "SELECT * FROM channels WHERE user_id = ? AND is_active = TRUE ORDER BY title",
                (user_id,)
            )
            return [dict(row) for row in self.cursor.fetchall()]
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤: {e}")
            return []
    
    def get_user_posts(self, user_id: int, limit: int = 50) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            self.cursor.execute(
                "SELECT * FROM posts WHERE user_id = ? ORDER BY created_at DESC LIMIT ?",
                (user_id, limit)
            )
            posts = []
            for row in self.cursor.fetchall():
                post = dict(row)
                post['channels'] = json.loads(post['channels_json']) if post['channels_json'] else []
                posts.append(post)
            return posts
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤: {e}")
            return []
    
    def get_timezones(self) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤"""
        try:
            self.cursor.execute(
                "SELECT * FROM timezones WHERE is_active = TRUE ORDER BY name"
            )
            return [dict(row) for row in self.cursor.fetchall()]
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤: {e}")
            return []
    
    def add_notification(self, user_id: int, type: str, title: str, message: str):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
        try:
            self.cursor.execute(
                '''INSERT INTO notifications 
                   (user_id, type, title, message) 
                   VALUES (?, ?, ?, ?)''',
                (user_id, type, title, message)
            )
            self.conn.commit()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
    
    def get_notifications(self, user_id: int, limit: int = 10) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            self.cursor.execute(
                '''SELECT * FROM notifications 
                   WHERE user_id = ? 
                   ORDER BY created_at DESC 
                   LIMIT ?''',
                (user_id, limit)
            )
            return [dict(row) for row in self.cursor.fetchall()]
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {e}")
            return []
    
    def get_post_user_id(self, post_id: int) -> Optional[int]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID –ø–æ—Å—Ç–∞"""
        try:
            self.cursor.execute(
                "SELECT user_id FROM posts WHERE id = ?",
                (post_id,)
            )
            result = self.cursor.fetchone()
            return result['user_id'] if result else None
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å—Ç–∞: {e}")
            return None

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
db = Database()

# –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
scheduler.start()

# ============================
# –î–ï–ö–û–†–ê–¢–û–†–´ –î–û–°–¢–£–ü–ê
# ============================

def login_required(f):
    """–¢—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            flash('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'warning')
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    decorated_function.__name__ = f.__name__
    return decorated_function

def bot_token_required(f):
    """–¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞"""
    def decorated_function(*args, **kwargs):
        user_id = session.get('user_id')
        if user_id:
            user = db.get_user(user_id)
            if not user or not user.get('bot_token'):
                flash('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ', 'warning')
                return redirect(url_for('profile'))
        return f(*args, **kwargs)
    decorated_function.__name__ = f.__name__
    return decorated_function

# ============================
# HTML –®–ê–ë–õ–û–ù–´
# ============================

def render_template(template_name, **context):
    """–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤"""
    templates = {
        'index.html': '''
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Scheduler - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏</title>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f9fafb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { max-width: 1200px; width: 100%; }
        .hero { background: rgba(255, 255, 255, 0.95); border-radius: 24px; padding: 60px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        h1 { font-size: 3.5rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; }
        .subtitle { color: #6b7280; font-size: 1.25rem; line-height: 1.7; margin-bottom: 3rem; }
        .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin: 3rem 0; }
        .feature { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); transition: all 0.3s; border: 1px solid #e5e7eb; }
        .feature:hover { transform: translateY(-8px); box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15); }
        .feature-icon { font-size: 3rem; margin-bottom: 1.5rem; display: inline-block; }
        .feature h3 { font-size: 1.5rem; color: var(--dark); margin-bottom: 1rem; }
        .feature p { color: #6b7280; line-height: 1.6; }
        .cta-buttons { display: flex; gap: 1rem; margin-top: 3rem; flex-wrap: wrap; }
        .btn { padding: 1rem 2rem; border-radius: 12px; font-size: 1.125rem; font-weight: 600; text-decoration: none; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); }
        @media (max-width: 768px) { .hero { padding: 2rem; } h1 { font-size: 2.5rem; } .cta-buttons { flex-direction: column; } .btn { text-align: center; justify-content: center; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1>ü§ñ Telegram Scheduler Pro</h1>
            <p class="subtitle">–ú–æ—â–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º–∏ –≤ Telegram –∫–∞–Ω–∞–ª–∞—Ö. –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ—Å—Ç—ã, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Ä–∞–∑–≤–∏–≤–∞–π—Ç–µ —Å–≤–æ–∏ –∫–∞–Ω–∞–ª—ã —Å –ø–æ–º–æ—â—å—é –≤–∞—à–µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞.</p>
            
            <div class="features">
                <div class="feature">
                    <div class="feature-icon">üöÄ</div>
                    <h3>–í–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–æ—Ç</h3>
                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–µ–≥–æ Telegram –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π. –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">üìÖ</div>
                    <h3>–£–º–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                    <p>–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –¥–Ω–∏, –Ω–µ–¥–µ–ª–∏ –∏ –º–µ—Å—è—Ü—ã –≤–ø–µ—Ä–µ–¥. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤.</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">üìä</div>
                    <h3>–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
                    <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É –∫–∞–Ω–∞–ª—É. –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">üîî</div>
                    <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                    <p>–ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä—è–º–æ –≤ Telegram —á–µ—Ä–µ–∑ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞.</p>
                </div>
            </div>
            
            <div class="cta-buttons">
                <a href="/register" class="btn btn-primary">üìù –ù–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</a>
                <a href="/login" class="btn btn-secondary">üîê –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
            </div>
        </div>
    </div>
</body>
</html>
        ''',
        
        'login.html': '''
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ - Telegram Scheduler</title>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --danger: #ef4444;
            --success: #10b981;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-container { background: white; border-radius: 20px; padding: 3rem; width: 100%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .logo { text-align: center; margin-bottom: 2rem; }
        .logo h1 { font-size: 2rem; color: #1f2937; margin-bottom: 0.5rem; }
        .logo p { color: #6b7280; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 500; }
        .form-input { width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: border-color 0.3s; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .btn { width: 100%; padding: 0.875rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); }
        .alert { padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .links { text-align: center; margin-top: 2rem; color: #6b7280; }
        .links a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .links a:hover { text-decoration: underline; }
        .back-link { display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem; color: #6b7280; text-decoration: none; }
        .back-link:hover { color: var(--primary); }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <h1>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
            <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <form method="POST" action="/login">
            <div class="form-group">
                <label class="form-label" for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" id="username" name="username" class="form-input" required autofocus>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="password" name="password" class="form-input" required>
            </div>
            
            <button type="submit" class="btn">–í–æ–π—Ç–∏</button>
        </form>
        
        <div class="links">
            <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
            <a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
    </div>
</body>
</html>
        ''',
        
        'register.html': '''
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - Telegram Scheduler</title>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .register-container { background: white; border-radius: 20px; padding: 3rem; width: 100%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .logo { text-align: center; margin-bottom: 2rem; }
        .logo h1 { font-size: 2rem; color: #1f2937; margin-bottom: 0.5rem; }
        .logo p { color: #6b7280; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 500; }
        .form-input { width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: border-color 0.3s; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-help { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
        .form-help a { color: var(--primary); }
        .btn { width: 100%; padding: 0.875rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); }
        .alert { padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .links { text-align: center; margin-top: 2rem; color: #6b7280; }
        .links a { color: var(--primary); text-decoration: none; font-weight: 500; }
        .links a:hover { text-decoration: underline; }
        .back-link { display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem; color: #6b7280; text-decoration: none; }
        .back-link:hover { color: var(--primary); }
        .token-info { background: #f3f4f6; padding: 1rem; border-radius: 10px; margin: 1rem 0; border-left: 4px solid var(--primary); }
        .token-info h3 { margin-bottom: 0.5rem; color: #1f2937; }
        .token-info p { color: #6b7280; font-size: 0.9rem; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="register-container">
        <div class="logo">
            <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</p>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="token-info">
            <h3>üì± –¢—Ä–µ–±—É–µ—Ç—Å—è Telegram Bot Token</h3>
            <p>–î–ª—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –≤–∞–º –Ω—É–∂–µ–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π Telegram –±–æ—Ç. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É <a href="https://t.me/BotFather" target="_blank">@BotFather</a> –∫–æ–º–∞–Ω–¥–∞–º–∏:</p>
            <p>1. <code>/newbot</code> - —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞</p>
            <p>2. <code>/token</code> - –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–æ—Ç–∞</p>
            <p>–¢–æ–∫–µ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫: <code>1234567890:ABCdefGHIjklMNOpqrsTUVwxyz</code></p>
        </div>
        
        <form method="POST" action="/register">
            <div class="form-group">
                <label class="form-label" for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
                <input type="text" id="username" name="username" class="form-input" required>
                <div class="form-help">–õ–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã ._-</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="email">Email</label>
                <input type="email" id="email" name="email" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å *</label>
                <input type="password" id="password" name="password" class="form-input" required>
                <div class="form-help">–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="confirm_password">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label>
                <input type="password" id="confirm_password" name="confirm_password" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="telegram_id">–í–∞—à Telegram ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <input type="number" id="telegram_id" name="telegram_id" class="form-input">
                <div class="form-help">–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–∞–º –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="bot_token">Telegram Bot Token *</label>
                <input type="text" id="bot_token" name="bot_token" class="form-input" required placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                <div class="form-help">–¢–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –æ—Ç @BotFather</div>
            </div>
            
            <button type="submit" class="btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </form>
        
        <div class="links">
            <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="/login">–í–æ–π—Ç–∏</a></p>
            <a href="/" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
    </div>
</body>
</html>
        ''',
        
        'dashboard.html': '''
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - Telegram Scheduler</title>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f3f4f6; color: var(--dark); }
        .navbar { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: bold; display: flex; align-items: center; gap: 0.75rem; }
        .nav-links { display: flex; gap: 1.5rem; align-items: center; }
        .nav-link { color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 8px; transition: background 0.3s; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
        .nav-link:hover { background: rgba(255, 255, 255, 0.1); }
        .nav-link.active { background: rgba(255, 255, 255, 0.2); }
        .user-menu { display: flex; align-items: center; gap: 1rem; }
        .user-avatar { width: 40px; height: 40px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .welcome-card { background: white; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-left: 6px solid var(--primary); }
        .welcome-card h1 { font-size: 2rem; margin-bottom: 0.5rem; color: var(--dark); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.3s; border-top: 4px solid var(--primary); }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2.5rem; font-weight: bold; margin: 0.5rem 0; }
        .stat-success { color: var(--success); }
        .stat-warning { color: var(--warning); }
        .stat-danger { color: var(--danger); }
        .stat-label { color: #6b7280; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
        .action-btn { background: white; border: none; padding: 1.5rem; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 1rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-decoration: none; color: inherit; }
        .action-btn:hover { background: var(--primary); color: white; transform: translateY(-3px); box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); }
        .action-icon { font-size: 2.5rem; }
        .recent-section { background: white; border-radius: 16px; padding: 2rem; margin-top: 2rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .section-title { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--dark); display: flex; align-items: center; gap: 0.75rem; }
        .posts-list { display: flex; flex-direction: column; gap: 1rem; }
        .post-item { padding: 1rem; border-radius: 8px; background: var(--light); display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }
        .post-item:hover { background: #e5e7eb; }
        .post-content { flex: 1; }
        .post-title { font-weight: 600; margin-bottom: 0.25rem; }
        .post-meta { color: #6b7280; font-size: 0.875rem; display: flex; gap: 1rem; }
        .post-status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-published { background: #d1fae5; color: var(--success); }
        .status-scheduled { background: #fef3c7; color: var(--warning); }
        .status-draft { background: #dbeafe; color: var(--primary); }
        .bot-status { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; font-size: 0.875rem; }
        .bot-online { background: #d1fae5; color: var(--success); }
        .bot-offline { background: #fee2e2; color: var(--danger); }
        .notifications { position: fixed; top: 5rem; right: 2rem; z-index: 1000; max-width: 400px; }
        .notification { background: white; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-left: 4px solid var(--primary); animation: slideIn 0.3s ease; }
        .notification-success { border-left-color: var(--success); }
        .notification-error { border-left-color: var(--danger); }
        .notification-warning { border-left-color: var(--warning); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        @media (max-width: 768px) { 
            .navbar { flex-direction: column; gap: 1rem; padding: 1rem; } 
            .nav-links { flex-wrap: wrap; justify-content: center; }
            .container { padding: 1rem; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <span>ü§ñ</span>
            <span>Telegram Scheduler</span>
        </div>
        <div class="nav-links">
            <a href="/dashboard" class="nav-link active">üìä –î–∞—à–±–æ—Ä–¥</a>
            <a href="/posts" class="nav-link">üìù –ü–æ—Å—Ç—ã</a>
            <a href="/channels" class="nav-link">üì¢ –ö–∞–Ω–∞–ª—ã</a>
            <a href="/statistics" class="nav-link">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a href="/profile" class="nav-link">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
        <div class="user-menu">
            <div class="user-avatar">{{ username[0].upper() }}</div>
            <span>{{ username }}</span>
            <a href="/logout" class="nav-link" style="background: rgba(255,255,255,0.2);">üö™ –í—ã—Ö–æ–¥</a>
        </div>
    </nav>

    <div class="container">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        {% if notifications %}
        <div class="notifications">
            {% for notification in notifications %}
            <div class="notification notification-{{ notification.type }}">
                <strong>{{ notification.title }}</strong>
                <p style="margin-top: 0.5rem; font-size: 0.9rem;">{{ notification.message }}</p>
                <div style="text-align: right; margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                    {{ notification.created_at }}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="welcome-card">
            <h1>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ username }}!</h1>
            <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                {% if user.bot_token %}
                <span class="bot-status bot-online">‚úÖ –ë–æ—Ç: @{{ user.bot_username }}</span>
                {% else %}
                <span class="bot-status bot-offline">‚ùå –ë–æ—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>
                {% endif %}
                <span style="color: #6b7280;">üìç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: {{ user.timezone }}</span>
                <span style="color: #6b7280;">üìÖ –°–µ–≥–æ–¥–Ω—è: {{ current_date }}</span>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤</div>
                <div class="stat-value">{{ stats.total_posts or 0 }}</div>
                <div style="color: #6b7280; font-size: 0.875rem;">–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ö–∞–Ω–∞–ª—ã</div>
                <div class="stat-value">{{ stats.total_channels or 0 }}</div>
                <div style="color: #6b7280; font-size: 0.875rem;">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                <div class="stat-value stat-success">{{ stats.today_posts or 0 }}</div>
                <div style="color: #6b7280; font-size: 0.875rem;">–°–æ–∑–¥–∞–Ω–æ –ø–æ—Å—Ç–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í –æ—á–µ—Ä–µ–¥–∏</div>
                <div class="stat-value stat-warning">{{ stats.scheduled_posts or 0 }}</div>
                <div style="color: #6b7280; font-size: 0.875rem;">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>
        </div>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="quick-actions">
            <a href="/posts?create=new" class="action-btn">
                <span class="action-icon">‚úèÔ∏è</span>
                <span>–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</span>
            </a>
            <a href="/channels?add=new" class="action-btn">
                <span class="action-icon">üì¢</span>
                <span>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª</span>
            </a>
            <a href="/statistics" class="action-btn">
                <span class="action-icon">üìä</span>
                <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
            </a>
            <a href="/profile" class="action-btn">
                <span class="action-icon">‚öôÔ∏è</span>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </a>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã -->
        <div class="recent-section">
            <h2 class="section-title">üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã</h2>
            {% if recent_posts %}
            <div class="posts-list">
                {% for post in recent_posts %}
                <div class="post-item">
                    <div class="post-content">
                        <div class="post-title">
                            {% if post.title %}{{ post.title }}
                            {% else %}{{ post.content[:50] }}{% if post.content|length > 50 %}...{% endif %}
                            {% endif %}
                        </div>
                        <div class="post-meta">
                            <span>üìÖ {{ post.created_at[:16] }}</span>
                            <span>üì¢ {{ post.channels|length }} –∫–∞–Ω–∞–ª–æ–≤</span>
                        </div>
                    </div>
                    <div class="post-status status-{{ post.status }}">
                        {% if post.status == 'published' %}‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω
                        {% elif post.status == 'scheduled' %}‚è≥ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω
                        {% elif post.status == 'failed' %}‚ùå –û—à–∏–±–∫–∞
                        {% else %}üìù –ß–µ—Ä–Ω–æ–≤–∏–∫{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div style="text-align: center; margin-top: 1.5rem;">
                <a href="/posts" style="background: var(--primary); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">
                    –í—Å–µ –ø–æ—Å—Ç—ã ‚Üí
                </a>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <p>–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤</p>
                <a href="/posts?create=new" style="display: inline-block; margin-top: 1rem; background: var(--primary); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 600;">
                    –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        setTimeout(() => {
            const notifications = document.querySelectorAll('.notification');
            notifications.forEach(notification => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            });
        }, 5000);
    </script>
</body>
</html>
        '''
    }
    
    if template_name in templates:
        return render_template_string(templates[template_name], **context)
    else:
        return f"–®–∞–±–ª–æ–Ω {template_name} –Ω–µ –Ω–∞–π–¥–µ–Ω", 404

# ============================
# –ú–ê–†–®–†–£–¢–´ FLASK
# ============================

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    if 'user_id' in session:
        return redirect(url_for('dashboard'))
    return render_template('index.html')

@app.route('/login', methods=['GET', 'POST'])
def login():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞"""
    if 'user_id' in session:
        return redirect(url_for('dashboard'))
    
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        
        user = db.authenticate_user(username, password)
        if user:
            session['user_id'] = user['id']
            session['username'] = user['username']
            session['is_admin'] = user.get('is_admin', False)
            session['timezone'] = user.get('timezone', DEFAULT_TIMEZONE)
            
            flash('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success')
            return redirect(url_for('dashboard'))
        else:
            flash('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'danger')
    
    return render_template('login.html')

@app.route('/register', methods=['GET', 'POST'])
def register():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    if 'user_id' in session:
        return redirect(url_for('dashboard'))
    
    if request.method == 'POST':
        username = request.form.get('username')
        email = request.form.get('email')
        password = request.form.get('password')
        confirm_password = request.form.get('confirm_password')
        telegram_id = request.form.get('telegram_id')
        bot_token = request.form.get('bot_token')
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not username or not password or not bot_token:
            flash('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'danger')
            return render_template('register.html')
        
        if password != confirm_password:
            flash('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'danger')
            return render_template('register.html')
        
        if len(password) < 8:
            flash('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤', 'danger')
            return render_template('register.html')
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        success, message, user_id = db.create_user(
            username, password, email, telegram_id, bot_token
        )
        
        if success:
            flash(message, 'success')
            return redirect(url_for('login'))
        else:
            flash(message, 'danger')
    
    return render_template('register.html')

@app.route('/logout')
def logout():
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    session.clear()
    flash('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'info')
    return redirect(url_for('index'))

@app.route('/dashboard')
@login_required
def dashboard():
    """–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
    user_id = session['user_id']
    user = db.get_user(user_id)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    today = datetime.now().date()
    
    # –ü—Ä–æ—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = {
        'total_posts': len(db.get_user_posts(user_id, 1000)),
        'total_channels': len(db.get_user_channels(user_id)),
        'today_posts': 0,  # –ù—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥—Å—á–µ—Ç
        'scheduled_posts': 0  # –ù—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥—Å—á–µ—Ç
    }
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã
    recent_posts = db.get_user_posts(user_id, 5)
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    notifications = db.get_notifications(user_id, 5)
    
    return render_template('dashboard.html',
                         username=session['username'],
                         user=user,
                         stats=stats,
                         recent_posts=recent_posts,
                         notifications=notifications,
                         current_date=datetime.now().strftime('%d.%m.%Y'))

@app.route('/profile')
@login_required
def profile():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è"""
    user_id = session['user_id']
    user = db.get_user(user_id)
    timezones = db.get_timezones()
    
    return render_template('profile.html',
                         user=user,
                         timezones=timezones)

@app.route('/profile/update', methods=['POST'])
@login_required
def update_profile():
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è"""
    user_id = session['user_id']
    
    timezone = request.form.get('timezone')
    telegram_id = request.form.get('telegram_id')
    email = request.form.get('email')
    
    if timezone:
        db.update_user_timezone(user_id, timezone)
        session['timezone'] = timezone
    
    # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
    
    flash('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success')
    return redirect(url_for('profile'))

@app.route('/channels')
@login_required
@bot_token_required
def channels_page():
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏"""
    user_id = session['user_id']
    user_channels = db.get_user_channels(user_id)
    
    return render_template('channels.html',
                         channels=user_channels)

@app.route('/channels/add', methods=['POST'])
@login_required
@bot_token_required
def add_channel():
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"""
    user_id = session['user_id']
    channel_id = request.form.get('channel_id')
    
    if not channel_id:
        return jsonify({'success': False, 'error': '–£–∫–∞–∂–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞'})
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ
    user = db.get_user(user_id)
    chat_info = TelegramBotManager.get_chat_info(user['bot_token'], channel_id)
    
    if not chat_info:
        return jsonify({'success': False, 'error': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–Ω–∞–ª–µ'})
    
    channel_data = {
        'channel_id': str(chat_info['id']),
        'title': chat_info.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
        'username': chat_info.get('username'),
        'invite_link': chat_info.get('invite_link'),
        'subscribers_count': chat_info.get('members_count', 0)
    }
    
    success, message = db.add_channel(user_id, channel_data)
    
    return jsonify({
        'success': success,
        'message': message,
        'channel': channel_data if success else None
    })

@app.route('/posts')
@login_required
@bot_token_required
def posts_page():
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏"""
    user_id = session['user_id']
    user_posts = db.get_user_posts(user_id, 50)
    user_channels = db.get_user_channels(user_id)
    
    return render_template('posts.html',
                         posts=user_posts,
                         channels=user_channels)

@app.route('/posts/create', methods=['POST'])
@login_required
@bot_token_required
def create_post_api():
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ (API)"""
    user_id = session['user_id']
    
    try:
        post_data = {
            'title': request.form.get('title'),
            'content_type': request.form.get('content_type', 'text'),
            'content': request.form.get('content'),
            'media_url': request.form.get('media_url'),
            'media_type': request.form.get('media_type'),
            'channels': request.form.getlist('channels'),
            'scheduled_time': request.form.get('scheduled_time'),
            'timezone': request.form.get('timezone', session.get('timezone', DEFAULT_TIMEZONE)),
            'status': request.form.get('status', 'draft')
        }
        
        success, message, post_id = db.create_post(user_id, post_data)
        
        return jsonify({
            'success': success,
            'message': message,
            'post_id': post_id
        })
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        })

@app.route('/posts/<int:post_id>/send', methods=['POST'])
@login_required
@bot_token_required
def send_post_api(post_id: int):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞"""
    user_id = session['user_id']
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    post_user_id = db.get_post_user_id(post_id)
    if not post_user_id or post_user_id != user_id:
        return jsonify({'success': False, 'error': '–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'})
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
    db.send_post_immediately(post_id, user_id)
    
    return jsonify({
        'success': True,
        'message': '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞'
    })

@app.route('/statistics')
@login_required
def statistics_page():
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
    user_id = session['user_id']
    
    # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    stats = {
        'total_posts': 0,
        'published_posts': 0,
        'failed_posts': 0,
        'total_views': 0,
        'channels_stats': []
    }
    
    return render_template('statistics.html',
                         stats=stats)

# ============================
# –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================

if __name__ == '__main__':
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    scheduler.start()
    
    print("=" * 50)
    print("Telegram Scheduler Web –∑–∞–ø—É—â–µ–Ω!")
    print("=" * 50)
    print(f"–°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:5000")
    print(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: admin / Admin123!")
    print("=" * 50)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask
    app.run(host='0.0.0.0', port=5000, debug=True)
